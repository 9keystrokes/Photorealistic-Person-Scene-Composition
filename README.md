# Photorealistic Person Scene Composition

## Project Overview
This computer vision project implements an advanced image processing pipeline to seamlessly integrate a person into any background scene with photorealistic results. The system handles background removal, lighting analysis, color matching, and shadow generation to create natural-looking composite images.

## Table of Contents
- [Key Features](#key-features)
- [Example Output](#example-output)
- [Project Structure](#project-structure)
- [Technical Pipeline](#technical-pipeline)
- [Shadow Detection Algorithm](#shadow-detection-algorithm)
- [Technical Implementation](#technical-implementation)
  - [Background Removal & Image Preprocessing](#background-removal--image-preprocessing)
  - [Lighting Analysis & Shadow Detection](#lighting-analysis--shadow-detection)
  - [Light Direction Estimation](#light-direction-estimation)
  - [Advanced Color Matching & Tone Adjustment](#advanced-color-matching--tone-adjustment)
  - [Final Composition & Rendering](#final-composition--rendering)
- [Technologies Used](#technologies-used)
- [Installation & Usage](#installation--usage)
- [Developer Information](#developer-information)

## Key Features

- **Automated Background Removal**: Utilizes advanced AI models for precise person extraction
- **Intelligent Color Matching**: LAB color space histogram matching for natural skin tones
- **Dynamic Shadow Generation**: Real-time shadow synthesis based on scene lighting analysis
- **Advanced Tone Adjustment**: Multi-stage color correction including gamma, saturation, and warmth
- **Edge Blending**: Sophisticated alpha compositing for seamless integration

## Example Output

Below are the input and output images generated by the script:

<table>
  <tr>
    <td align="center"><strong>Input: Person</strong><br><img src="inputs/person.jpg" alt="Person Input" width="240"/></td>
    <td align="center"><strong>Input: Background</strong><br><img src="inputs/background.jpg" alt="Background Input" width="300"/></td>
    <td align="center"><strong>Output: Final Composite</strong><br><img src="output/final_composite.jpg" alt="Final Composite Image Output" width="300"/></td>
  </tr>
  <tr>
    <td align="center"><strong>Output: Extracted Person</strong><br><img src="output/extracted_person.jpg" alt="Extracted Person Output" width="240"/></td>
    <td align="center"><strong>Output: Background Shadow Hard</strong><br><img src="output/background_shadow_hard.jpg" alt="Background Shadow Hard Output" width="300"/></td>
    <td align="center"><strong>Output: Background Shadow Soft</strong><br><img src="output/background_shadow_soft.jpg" alt="Background Shadow Soft Output" width="300"/></td>
  </tr>
</table>

## Project Structure
- `compose.py`: main script to remove background, match colors, estimate lighting/shadows, and composite.
- `inputs/`: drop `person.jpg` (front view) and `background.jpg` (scene).
- `output/`: generated masks and final composite image.

## Technical Pipeline

```mermaid
flowchart LR
    A[Inputs: person.jpg & background.jpg] --> B[Background Removal]
    B --> C[Preprocessing & Alignment]
    C --> D[Color Matching & Tone Adjustment]
    D --> E[Shadow Detection]
    E --> F[Light Direction Computation]
    F --> G[Composite Placement & Blending]
    G --> H[Output: final_composite.jpg]
```

## Shadow Detection Algorithm

```mermaid
flowchart LR
    I[Background Image] --> J[Convert to Grayscale]
    J --> K[Thresholding]
    K --> L[Morphological Closing & Blurring]
    L --> M[Generate Hard Shadow Mask]
    L --> N[Generate Soft Shadow Mask]
```

# TECHNICAL IMPLEMENTATION

## Background Removal & Image Preprocessing

1. **Capture a High-Quality Image**
   - Front-view portrait in a well-lit, evenly exposed environment.
   - Use a neutral background or chroma key if available to simplify segmentation.

2. **Remove the Background**
   - Use an automated matting or background-removal tool (e.g., `rembg`).
   - Output: transparent `person.png` with alpha channel.

3. **Preprocessing & Alignment** *(missing step)*
   - **Scale & Orientation**: Resize and orient the extracted person to match the perspective of the new scene.
   - **Edge Feathering**: Apply slight blur to the alpha matte to avoid hard edges when compositing.

## Lighting Analysis & Shadow Detection

1. **Detect and Classify Shadows**
   - Convert background to grayscale and threshold to isolate dark regions.
   - Morphological closing and blurring to separate **hard** (sharp) vs **soft** (diffuse) shadows.
   - Generate and save binary masks: `shadow_hard.png`, `shadow_soft.png`.

2. **Refine Shadow Masks** *(missing step)*
   - Use adaptive thresholding or color-based segmentation to handle textured backgrounds.
   - Optionally incorporate edge detection to refine shadow boundaries.

## Light Direction Estimation

1. **Outdoor Scenes**
   - Compute 2D centroids of the person mask and the soft-shadow mask.
   - Derive a 3D light vector by adding a downward Z component proportional to scene scale.
   - Normalize to unit length: `light_dir`.

2. **Indoor Scenes** *(missing step)*
   - Estimate approximate lighting direction by analyzing image gradients or using deep-learning light-estimation networks.
   - Use detected strong highlights/shadows on scene objects to infer light positions.

## Advanced Color Matching & Tone Adjustment

1. **Color Matching**
   - Convert person and background crops to LAB color space.
   - Match only the L-channel histogram to preserve skin chroma.

2. **Gamma & Tone Adjustment**
   - Apply gentle gamma correction (e.g., γ=0.9–0.95) for midtone consistency.
   - Use LUT-based corrections for efficient per-channel mapping.

3. **Contrast & Saturation Enhancement**
   - Apply CLAHE on L-channel for local contrast improvements.
   - Boost saturation in HSV space by a controlled factor (1.05–1.15).

4. **Warmth & Vibrance Tweaks**
   - Slightly increase the red channel and LAB a/b channels for warmth (+3–5 units).
   - Final vibrance boost by increasing mid-level saturation.

5. **Edge Blending** *(missing step)*
   - Feather composite edges using the alpha mask to avoid halos.
   - Use multi-scale Gaussian pyramid blending if high realism is required.

## Final Composition & Rendering

1. **Composite Placement**
   - Position person at the desired location with offsets matching scene perspective.
   - Overlay synthetic shadow beneath the person based on the computed light direction.

2. **Final Composite Rendering**
   - Blend person and shadow into the background using manual alpha compositing.
   - Save output in matching format (e.g., `final_composite.jpg`).

## Technologies Used
- **Programming Languages**: Python
- **Computer Vision**: OpenCV, NumPy, scikit-image
- **AI/ML Libraries**: rembg (background removal)
- **Image Processing**: LAB color space, histogram matching, morphological operations
- **Research Foundation**: Image harmonization and color transfer techniques (Reinhard et al. 2001)

## Installation & Usage
1. Place `person.jpg` and `background.jpg` in the `inputs` folder.
2. Install dependencies:
   ```powershell
   pip install -r requirements.txt
   ```
3. Run the script:
   ```powershell
   python compose.py --no-shadow
   ```
4. Review results in `output/`.

## Developer Information

<table>
  <tr>
    <td><strong>Name:</strong></td>
    <td>Nayan Mandal</td>
    <td><strong>Roll No.:</strong></td>
    <td>BT22CSD035</td>
  </tr>
  <tr>
    <td><strong>Program:</strong></td>
    <td colspan="3">B.Tech - Computer Science Engineering (Minor in Data Science and Analytics)</td>
  </tr>
  <tr>
    <td><strong>Institute:</strong></td>
    <td colspan="3">Indian Institute Of Information Technology, Nagpur</td>
  </tr>
  <tr>
    <td><strong>Email (Institute):</strong></td>
    <td><a href="mailto:bt22csd035@iiitn.ac.in">bt22csd035@iiitn.ac.in</a></td>
    <td><strong>Email (Personal):</strong></td>
    <td><a href="mailto:nayan.iiitn@gmail.com">nayan.iiitn@gmail.com</a></td>
  </tr>
  <tr>
    <td><strong>GitHub:</strong></td>
    <td><a href="https://github.com/9keystrokes">github.com/9keystrokes</a></td>
    <td><strong>LinkedIn:</strong></td>
    <td><a href="https://linkedin.com/in/9keystrokes">linkedin.com/in/9keystrokes</a></td>
  </tr>
</table>